# üöÄ Convex Setup & Deployment Guide

This guide will walk you through setting up Convex for the Computer Guys chatbot project.

## Prerequisites

- Node.js 20.18.0 or higher
- PNPM 9.15.4 or higher
- A Convex account (free at https://convex.dev)

## Step 1: Login to Convex

First, you need to authenticate with Convex:

```bash
cd packages/convex
npx convex login
```

This will open your browser to authenticate. Follow the prompts to log in.

## Step 2: Initialize Convex Project

Initialize a new Convex project and create a deployment:

```bash
npx convex dev --once --configure=new
```

When prompted:

1. **Project name**: Enter `cg-chat` or your preferred name
2. **Choose deployment**: Select "Create a new project"
3. **Team**: Select your team or create a new one

This command will:

- Create a new Convex project
- Generate a `convex.json` file (already exists in our setup)
- Set up a development deployment
- Create the `.convex` directory with credentials
- Deploy your schema and functions once, then exit

## Step 3: Deploy Schema and Functions

Deploy your schema and functions to Convex:

```bash
# Start the development server (keep this running)
npx convex dev
```

In a new terminal, generate TypeScript types:

```bash
cd packages/convex
npx convex codegen
```

This will:

- Deploy all tables defined in `schema.ts`
- Upload all functions (users.ts, conversations.ts, messages.ts, etc.)
- Generate TypeScript types in `_generated/` directory
- Start real-time sync with your deployment

## Step 4: Set Environment Variables

### Local Environment (.env.local)

After initialization, update your `.env.local` file in the project root:

```env
# Get these values from your Convex dashboard
CONVEX_DEPLOYMENT=<your-deployment-name>
CONVEX_URL=https://<your-deployment>.convex.cloud
NEXT_PUBLIC_CONVEX_URL=https://<your-deployment>.convex.cloud
```

To find these values:

1. Go to https://dashboard.convex.dev
2. Select your project
3. Click on "Settings"
4. Copy the deployment URL

### Convex Environment Variables

Set environment variables in Convex for external services:

```bash
# OpenRouter API Key (for LLM access)
npx convex env set OPENROUTER_API_KEY your_openrouter_api_key

# Twilio credentials (for WhatsApp)
npx convex env set TWILIO_ACCOUNT_SID your_twilio_sid
npx convex env set TWILIO_AUTH_TOKEN your_twilio_token

# JWT Secret (for authentication)
npx convex env set JWT_SECRET your_secure_jwt_secret

# Node environment
npx convex env set NODE_ENV development
```

Verify environment variables:

```bash
npx convex env list
```

## Step 5: Verify Deployment

### Check Dashboard

1. Open Convex Dashboard:

```bash
npx convex dashboard
```

2. Verify:
   - All 9 tables are created (users, conversations, messages, etc.)
   - All functions are deployed
   - Vector index is configured for the knowledge table

### Test Functions

From the dashboard, you can test functions directly:

1. Go to "Functions" tab
2. Select any function (e.g., `users:createUser`)
3. Enter test arguments
4. Click "Run"

Example test for `users:createUser`:

```json
{
  "email": "test@example.com",
  "name": "Test User"
}
```

### Check Logs

Monitor function logs:

```bash
npx convex logs
```

Or filter by function:

```bash
npx convex logs --function users:createUser
```

## Step 6: Production Deployment (Optional)

When ready for production:

```bash
# Deploy to production
npx convex deploy --prod

# Set production environment variables
npx convex env set OPENROUTER_API_KEY your_key --prod
npx convex env set TWILIO_ACCOUNT_SID your_sid --prod
npx convex env set TWILIO_AUTH_TOKEN your_token --prod
npx convex env set JWT_SECRET your_secret --prod
npx convex env set NODE_ENV production --prod
```

## üìÅ Generated Files Structure

After setup, your Convex package will have:

```
packages/convex/
‚îú‚îÄ‚îÄ _generated/          # Auto-generated by Convex
‚îÇ   ‚îú‚îÄ‚îÄ api.d.ts        # TypeScript API types
‚îÇ   ‚îú‚îÄ‚îÄ api.js          # JavaScript API
‚îÇ   ‚îú‚îÄ‚îÄ dataModel.d.ts  # Data model types
‚îÇ   ‚îî‚îÄ‚îÄ server.d.ts     # Server types
‚îú‚îÄ‚îÄ .convex/            # Convex credentials (git-ignored)
‚îÇ   ‚îî‚îÄ‚îÄ credentials.json
‚îú‚îÄ‚îÄ convex.json         # Convex configuration
‚îú‚îÄ‚îÄ schema.ts           # Database schema
‚îú‚îÄ‚îÄ users.ts            # User functions
‚îú‚îÄ‚îÄ conversations.ts    # Conversation functions
‚îú‚îÄ‚îÄ messages.ts         # Message functions
‚îú‚îÄ‚îÄ agents.ts           # AI agent functions
‚îú‚îÄ‚îÄ auth.ts             # Authentication functions
‚îú‚îÄ‚îÄ env.ts              # Environment helpers
‚îî‚îÄ‚îÄ tsconfig.json       # TypeScript config
```

## üîß Useful Commands

```bash
# Development
npx convex dev              # Start dev server
npx convex codegen         # Generate types
npx convex logs            # View logs
npx convex dashboard       # Open dashboard

# Deployment
npx convex deploy          # Deploy to development
npx convex deploy --prod   # Deploy to production

# Environment
npx convex env list        # List env vars
npx convex env set KEY val # Set env var
npx convex env get KEY     # Get env var value

# Data Management
npx convex export          # Export data
npx convex import data.zip # Import data

# Troubleshooting
npx convex logout          # Logout
npx convex login           # Login again
npx convex dev --clear     # Clear and redeploy
```

## ‚ö†Ô∏è Important Notes

1. **Keep `convex dev` running** during development for real-time sync
2. **Run `codegen`** after any schema changes
3. **Never commit** `.convex/` directory or `convex.json` (already in .gitignore)
4. **Vector search** requires OpenAI API key for embeddings
5. **Rate limiting** is enforced at database level

## üîÑ Updating Schema

When you modify `schema.ts`:

1. Save the file
2. Convex dev server will auto-deploy changes
3. Run `npx convex codegen` to update types
4. Check dashboard for migration status

## üß™ Testing the Setup

Create a test file to verify everything works:

```typescript
// test-convex.ts
import { ConvexClient } from "convex/browser";

const client = new ConvexClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

async function test() {
  // Test user creation
  const userId = await client.mutation("users:createUser", {
    email: "test@example.com",
    name: "Test User",
  });

  console.log("Created user:", userId);

  // Test query
  const user = await client.query("users:getUserByEmail", {
    email: "test@example.com",
  });

  console.log("Found user:", user);
}

test().catch(console.error);
```

## üìä Monitoring

### Dashboard Metrics

- Function execution times
- Error rates
- Database usage
- Vector search performance

### Logs

- Real-time function logs
- Error tracking
- Performance metrics

## üÜò Troubleshooting

### "Cannot connect to deployment"

```bash
npx convex logout
npx convex login
npx convex dev --once --configure=new
```

### "Schema validation failed"

```bash
npx convex dev --clear
```

### "Types not generating"

```bash
rm -rf _generated
npx convex codegen
```

### "Environment variables not working"

```bash
npx convex env list
# Verify all required vars are set
```

## üìö Resources

- [Convex Documentation](https://docs.convex.dev)
- [Dashboard](https://dashboard.convex.dev)
- [Discord Community](https://convex.dev/community)
- [Schema Guide](https://docs.convex.dev/database/schemas)
- [Functions Guide](https://docs.convex.dev/functions)
- [Vector Search](https://docs.convex.dev/vector-search)

## ‚úÖ Setup Checklist

- [ ] Logged in to Convex CLI
- [ ] Initialized Convex project
- [ ] Deployment created
- [ ] Schema deployed
- [ ] Functions uploaded
- [ ] TypeScript types generated
- [ ] Environment variables set (local)
- [ ] Environment variables set (Convex)
- [ ] Dashboard accessible
- [ ] Test function executed successfully
- [ ] Logs visible
- [ ] Ready for development!

---

Once you complete these steps, your Convex backend will be fully operational and ready for the Computer Guys chatbot application!
